language: php

php:
  - 5.4

env:
  global:
    - PNAME='demo-ci'
    - PSITE='demo-ci'
    - PUUID='445bb8f4-2088-4b79-9f2a-f436a18e683c'
    - PSOURCE='dev'
    - secure: "BPwfRwlShRxfQuZt0zNqhEPCfCOUc++xxpL1aqXibEqSRvdVmGtymX9efSHEG2FWgqltZWc1GgKn3D54j2gpCJfWqZlqCG7lVS1iOw5XmSOJHHQq8fcWlH8Zj8wjtogfTMUviiRiL+rl+rEbJVN2tRo8OdTR0o0huPfenbAyLY0+7GuHoJ8aJpjSu10NOpPgARYJ2L7tw1iqTi76kR3kwKc24a7mBNn1OjjR0/7WceyKOIZ8VhAJAupVW/zzC/ArGaQmvJOYo28d5fmnA8JbuNLvYhFLdLDPDUNHzwrumpBAx2cOQ4P7OdQ9aRyThAeVVPHIb0hANHaYHBH7toZpKMt0/BgBxP4Tenar6UOklqayK6IeJBYjyxEBt0bflG5qEkb7FfKqjtnE7VjG+tn25KuHkb60pfsubc4W4vsdQYELBl3yluSa/bv5TPabxgvzWy5L2PR8KhlbPxTS7kbSp+KDDsr4CEeT95XzpK0kuUGDI2LED3XzHy23Hc09GNI4lqTvIDsRwOmL/dfFzo9Kux/VzSSg5SfoaS7/rdbAaY1V+zgdIvfXRkKZqu6UbNsIIv7NIcEiKLz1shPg6BCUQnfPlOjYP8TduFLOu3TPU4oI+GRvL/jP4vxwcqI0CwqhQNGJHKBPiQTWaXUTiT0oZZ1TW223Qbid7wS/bjwTL+o="
    - secure: "IfgjmwCTvrpW7SA71BLu0SFeSaSPu0UTpMuxQguJdq2CyiGoWd5aOdnYOhV9U8byvVH9o9KEfPoMaN4DZqdJo5C8rAnN3909l3dFQiZe5pVgVMUZyiS9MI1cw8JU2WqmehAk5ehEb7Q307+FGt3HV/G17hnHfN2PWhoDs0qL2F0z2vv3oryL9KSSFRoixghNfOC5mSP2dMB62YolEdvBg8q3x6qj5A4DVKl8UZI6OnZGespnDzs7/iKyD/1CJoqyhqjEXAbV8kgyTINYTmsXAVfEBZC527yakzx8KbC7+C3nHiyQvqjeWTGkpPqjN13vQpBGpXa0oSi1tYDTC6n0uzvuf32grIDUyMVAyonTBkv34fIUn4gATfBDy4gTLj2lYxoouzmiKbGhZfKqegtTxdkn/y+PzDSWsD8kRbM+jE3FEIwWceKuHWno3f8YNo3qxv3P9RBDeAsxzKi2RcslRZiH+YjlwZl9G6Wh4HbaWJDDK1yp+k3xF/47vHGJE6WlSVSNjHfusjdmumJF71A5x0Lm3GxTvIFtv3eW12SDPsVJ5V2Rg82+wMGoQC1HN0C7A2A964sAlG0duJKj8sgLEl+eB0c/DohFaWOk4EQxzjxG2ZvsehgL2FxicZgXX7+F1CQGcLTf/e+/Gq0IiMLe4avayTdus8RbxIpSNMHjceA="
    - PHOST='https://$TRAVIS_BRANCH-$PNAME.pantheon.io'

before_install:
  - sudo apt-get update > /dev/null

  - composer self-update
install:
  - echo "StrictHostKeyChecking no" > ~/.ssh/config
    # install php packages required for running a web server from drush on php 5.3
  - sudo apt-get install -y --force-yes php5-cgi php5-mysql

  # install drush globally
  - composer global require drush/drush:7.*

  # add composer's global bin directory to the path
  # see: https://github.com/drush-ops/drush#install---composer
  - export PATH="$HOME/.composer/vendor/bin:$PATH"
  # Install terminus.
  - git clone https://github.com/pantheon-systems/terminus.git $HOME/.drush/terminus
  - cd $HOME/.drush/terminus
  - composer update --no-dev
  - drush cc drush
  - echo "sendmail_path='true'" >> `php --ini | grep "Loaded Configuration" | awk '{print $4}'`

script:
  # stand up drupal
  - cd $TRAVIS_BUILD_DIR
  - composer install
  - npm install && npm update
  - cd sites/all/themes/manati
  - npm install && npm update
  - drush site-install manati -y --db-url=mysql://root@localhost/cidemo --db-su='root' --db-su-pw='' --site-name='CI-Demo'
  - drush updb -y && drush fra -y
  - drush cc all
  # Run behat tests
  - cd $TRAVIS_BUILD_DIR
  - drush runserver --server=builtin 8082 --strict=0 &
  - sleep 10
  - grunt
after_script:
  - drush status

after_success:
  - echo $TRAVIS_BRANCH
  - echo $TRAVIS_PULL_REQUEST
  - if [ $TRAVIS_BRANCH != 'master' ] && [ $TRAVIS_PULL_REQUEST != 'false' ] ; then git remote add pantheon ssh://codeserver.dev.$PUUID@codeserver.dev.$PUUID.drush.in:2222/~/repository.git && git push pantheon $TRAVIS_BRANCH && drush psite-ecreate $PUUID $TRAVIS_BRANCH --source=$PSOURCE || true && drush paliases && drush cc drush && cd $HOME && drush @pantheon.$PNAME.$TRAVIS_BRANCH updb -y --strict=0 && drush @pantheon.$PNAME.$TRAVIS_BRANCH fra -y --strict=0 ; fi
  - if [ $TRAVIS_BRANCH = 'master' ] && [ $TRAVIS_PULL_REQUEST = 'false' ] ; then git remote add pantheon ssh://codeserver.dev.$PUUID@codeserver.dev.$PUUID.drush.in:2222/~/repository.git && git push pantheon $TRAVIS_BRANCH && drush paliases && drush cc drush && cd $HOME && drush @pantheon.$PNAME.$TRAVIS_BRANCH updb -y --strict=0 && drush @pantheon.$PNAME.$TRAVIS_BRANCH fra -y --strict=0 ; fi
notifications:
#  irc: irc.freenode.org#elmsln

#  email: false
  slack:
    rooms:
      - secure: "krMbpPDhjEkP7G8VPb2CHuxpDbu3gnP8GjJpZl6FWz74vAi1M+oZ3RNKVUANQ/9A/pX1BmnhcKnCPBOzrBuDdPO8xDuVQ9rTmSYu8ZYXDy2UHHD/r0awaORc8TyZ3JeSFmGYCKTZBbTOl2sijuVQe3s1MO+XvPKJHZE40KHEEK1ytjJ8b5bWXlvzGYhsuqW6nRKir/19lyb5yEPnWMaEAxwjacLyeZn2LxNUFYdzcAMJuVoiU/9zNUuHLrBk2P/+/cXNH3yhR6VESB2deSF3k/mlPN4rlMK/IMazx+XF13SB0qsx/30CMlcZSsVk1n2myxisCWsV0ITBjiWQDJcPsgdR0EgFhkXsBKWXuHO8dhRoT1UsmHVXLrL9D0ite3PF50fCOtDVYiHMuWm9tFGKo2xzKqcuhcHjkCY68Co9fmTP4uEgMIf2uGrmJhVWrsmcDCVwWtMbwLu5n5TcX2U1a4rhYUnAvmAwiHoX+pmb00b3XbaM6Kl45/Uz40PhZRZ19+MhvGkx4FdMcR33h+TcaqnXY6YYuPSHAn4Cx9c72xn5rTsJ1EWWcKJBtv2kIxTfss0k7tB+UQHXvSJyQfmIyWrTsZ10PG97td2p1+IS1VzZmeIbqyCqDiUjBLSXmILE4ps9WNmCMXv/UWCGBFG+5oZTedIOh/AmEybA041l1AY="
#      - elmsln:WmKTRMe7k3IjprunaAVV3Jjg#code

